<script>
let db = [];
let seleccionados = [];
let objetivosGlobales = null;

const REPARTOS = { 
    desayuno: {p:0.1, g:0.1, ch:0.27}, 
    comida: {p:0.39, g:0.4, ch:0.26}, 
    merienda: {p:0.08, g:0.06, ch:0.17}, 
    cena: {p:0.43, g:0.44, ch:0.3} 
};

// CARGADOR BLINDADO CONTRA FORMATO EXCEL/ESPAÑA
fetch('alimentos.csv').then(r => r.text()).then(t => {
    const filas = t.split(/\r?\n/).filter(linea => linea.trim() !== "");
    db = filas.slice(1).map(f => {
        // Separamos por coma pero gestionamos posibles comillas de Excel
        const c = f.split(/,(?=(?:(?:[^"]*"){2})*[^"]*$)/); 
        
        const limpiar = (val) => {
            if(!val) return 0;
            // Quitamos comillas, espacios y cambiamos coma decimal por punto
            let s = val.replace(/"/g, '').replace(/\s/g, '').replace(',', '.');
            return parseFloat(s) || 0;
        };

        return { 
            n: c[0] ? c[0].replace(/"/g, '').trim() : "Error", 
            kcal: limpiar(c[1]), 
            p: limpiar(c[2]), 
            g: limpiar(c[3]), 
            ch: limpiar(c[4]) 
        };
    }).filter(a => a.n !== "Error");
    
    document.getElementById('listaAlimentos').innerHTML = db.map(a => `<option value="${a.n}">`).join('');
    document.getElementById('status').innerText = "✅ Base de datos cargada: " + db.length + " alimentos";
    document.getElementById('status').style.color = "green";
}).catch(err => {
    document.getElementById('status').innerText = "❌ Error al cargar CSV";
    console.error(err);
});

function calcularObjetivos() {
    const p = parseFloat(document.getElementById('peso').value);
    const a = parseFloat(document.getElementById('altura').value);
    const e = parseFloat(document.getElementById('edad').value);
    const g = document.getElementById('genero').value;
    
    let bmr = (g === 'hombre') ? (10*p + 6.25*a - 5*e + 5) : (10*p + 6.25*a - 5*e - 161);
    
    objetivosGlobales = {};
    let html = `<table><tr><th>Comida</th><th>Kcal</th><th>P (g)</th><th>G (g)</th><th>CH (g)</th></tr>`;
    
    const config = [
        {id:'Alta', m: parseFloat(document.getElementById('mAlta').value), rp:2.0, rg:1.1},
        {id:'Media', m: parseFloat(document.getElementById('mMedia').value), rp:1.7, rg:1.1},
        {id:'Baja', m: parseFloat(document.getElementById('mBaja').value), rp:1.4, rg:0.7}
    ];
    
    config.forEach(d => {
        const kcalT = Math.round(bmr * d.m);
        const pT = p * d.rp;
        const gT = p * d.rg;
        const chT = (kcalT - (pT*4) - (gT*9)) / 4;
        
        objetivosGlobales[d.id] = { p: pT, g: gT, ch: chT, c: {} };
        html += `<tr class="total-row"><td>Día ${d.id}</td><td>${kcalT}</td><td>${pT.toFixed(0)}</td><td>${gT.toFixed(0)}</td><td>${chT.toFixed(0)}</td></tr>`;
        
        for(let comida in REPARTOS) {
            const m = REPARTOS[comida];
            objetivosGlobales[d.id].c[comida] = { p: pT*m.p, g: gT*m.g, ch: chT*m.ch };
            html += `<tr><td>↳ ${comida}</td><td>-</td><td>${(pT*m.p).toFixed(1)}</td><td>${(gT*m.g).toFixed(1)}</td><td>${(chT*m.ch).toFixed(1)}</td></tr>`;
        }
    });
    
    document.getElementById('tablaResumen').innerHTML = html + `</table>`;
    document.getElementById('resultados').style.display = 'block';
    document.getElementById('seccionPlanificador').style.display = 'block';
}

function añadirAlimento() {
    const val = document.getElementById('buscador').value;
    const item = db.find(x => x.n === val);
    if(item) {
        seleccionados.push({...item, gramos: 100});
        document.getElementById('buscador').value = '';
        renderTags();
    }
}

function renderTags() {
    document.getElementById('tagsIngredientes').innerHTML = seleccionados.map((s, i) => 
        `<span class="tag">${s.n} <b onclick="seleccionados.splice(${i},1);renderTags()">✕</b></span>`).join('');
}

function generarReceta() {
    const d = document.getElementById('tipoDiaSel').value;
    const c = document.getElementById('comidaSel').value;
    const obj = objetivosGlobales[d].c[c];

    // Solver con más precisión para Mallorca
    for(let i=0; i<3000; i++) {
        let curP=0, curG=0, curCH=0;
        seleccionados.forEach(s => {
            curP += (s.p * s.gramos / 100);
            curG += (s.g * s.gramos / 100);
            curCH += (s.ch * s.gramos / 100);
        });
        
        seleccionados.forEach(s => {
            let errorP = (obj.p - curP) * (s.p / 25);
            let errorG = (obj.g - curG) * (s.g / 25);
            let errorCH = (obj.ch - curCH) * (s.ch / 25);
            s.gramos = Math.max(1, s.gramos + (errorP + errorG + errorCH) / 5);
        });
    }

    let tP=0, tG=0, tCH=0, tK=0;
    let resHtml = `<div class="receta-res"><h3>Resultado: ${c.toUpperCase()} (${d})</h3>`;
    resHtml += `<table><tr><th>Alimento</th><th>Gramos</th><th>Kcal</th><th>P</th><th>G</th><th>CH</th></tr>`;
    
    seleccionados.forEach(s => {
        const pA = (s.p * s.gramos / 100);
        const gA = (s.g * s.gramos / 100);
        const chA = (s.ch * s.gramos / 100);
        const kA = (s.kcal * s.gramos / 100);
        tP+=pA; tG+=gA; tCH+=chA; tK+=kA;
        resHtml += `<tr><td>${s.n}</td><td><b>${Math.round(s.gramos)}g</b></td><td>${Math.round(kA)}</td><td>${pA.toFixed(1)}</td><td>${gA.toFixed(1)}</td><td>${chA.toFixed(1)}</td></tr>`;
    });

    resHtml += `<tr class="total-row"><td>TOTAL REAL</td><td>-</td><td>${Math.round(tK)}</td><td>${tP.toFixed(1)}</td><td>${tG.toFixed(1)}</td><td>${tCH.toFixed(1)}</td></tr>`;
    resHtml += `</table><p style="font-size:0.8rem; color:gray;">Objetivo teórico: P:${obj.p.toFixed(1)} G:${obj.g.toFixed(1)} CH:${obj.ch.toFixed(1)}</p></div>`;
    document.getElementById('resultadoReceta').innerHTML = resHtml;
}
</script>
