<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Trail Nutri-ERP | Miquel V3.2</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        :root { 
            --primary: #0f172a; --accent: #10b981; --blue: #3b82f6; 
            --bg: #f8fafc; --card-bg: #ffffff; --text-main: #1e293b; 
            --text-light: #64748b; --error: #f43f5e;
        }
        
        body { font-family: 'Inter', system-ui, sans-serif; background: var(--bg); color: var(--text-main); line-height: 1.6; margin: 0; padding: 20px; }
        .container { max-width: 1100px; margin: 0 auto; }

        .card { background: var(--card-bg); padding: 30px; border-radius: 16px; box-shadow: 0 4px 20px -2px rgba(0,0,0,0.05); margin-bottom: 25px; border: 1px solid #f1f5f9; }

        h1 { font-size: 1.8rem; color: var(--primary); font-weight: 800; margin-bottom: 30px; display: flex; align-items: center; gap: 12px; }
        h3 { font-size: 0.9rem; text-transform: uppercase; letter-spacing: 0.05em; color: var(--text-light); margin-bottom: 20px; display: flex; align-items: center; gap: 8px; }

        .btn { padding: 12px 20px; border-radius: 10px; border: none; font-weight: 700; cursor: pointer; transition: 0.2s; display: inline-flex; align-items: center; gap: 8px; font-size: 0.85rem; }
        .btn-blue { background: var(--blue); color: white; }
        .btn-ghost { background: #f1f5f9; color: var(--text-light); }
        .btn-success { background: var(--accent); color: white; width: 100%; margin-top: 20px; }

        .grid-3 { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; }
        label { font-weight: 600; font-size: 0.8rem; color: var(--text-light); margin-bottom: 6px; display: block; }
        input, select { width: 100%; padding: 12px; border: 2px solid #f1f5f9; border-radius: 10px; font-size: 0.95rem; background: #fcfcfd; box-sizing: border-box; }

        .collapsible { display: none; margin-top: 20px; padding-top: 20px; border-top: 1px solid #f1f5f9; }

        table { width: 100%; border-collapse: collapse; margin-top: 15px; }
        th { background: #f8fafc; color: var(--text-light); font-weight: 600; padding: 12px; font-size: 0.7rem; text-transform: uppercase; border-bottom: 2px solid #f1f5f9; }
        td { padding: 12px; border-bottom: 1px solid #f1f5f9; text-align: center; font-size: 0.85rem; }
        
        .row-day { background: #f1f5f9; font-weight: 800; color: var(--primary); }
        .row-meal { color: var(--text-light); font-style: italic; }

        .chip { padding: 10px 18px; border-radius: 12px; background: #f1f5f9; cursor: pointer; font-size: 0.85rem; font-weight: 600; border: 2px solid transparent; }
        .chip input { display: none; }
        .chip:has(input:checked) { background: #eff6ff; border-color: var(--blue); color: var(--blue); }

        .input-gramos { width: 70px; text-align: center; font-weight: 700; border: 2px solid var(--blue); color: var(--blue); border-radius: 6px; }
        .locked { border-color: var(--error); color: var(--error); background: #fff1f2; }
        .deviation { font-size: 0.7rem; display: block; font-weight: 800; }
        .dev-ok { color: var(--accent); } .dev-err { color: var(--error); }
    </style>
</head>
<body>

<div class="container">
    <h1><i class="fa-solid fa-mountain-sun" style="color:var(--accent)"></i> Trail Nutri-ERP</h1>

    <div id="status" class="card" style="padding:15px; font-size:0.8rem;">‚è≥ Cargando base de datos...</div>

    <div class="card">
        <h3><i class="fa-solid fa-user-gear"></i> Perfil y Configuraci√≥n</h3>
        <div class="grid-3">
            <div><label>Peso (kg)</label><input type="number" id="peso" value="75"></div>
            <div><label>Altura (cm)</label><input type="number" id="altura" value="180"></div>
            <div><label>Edad</label><input type="number" id="edad" value="35"></div>
            <div><label>G√©nero</label><select id="genero"><option value="hombre">Hombre</option><option value="mujer">Mujer</option></select></div>
            <div><label>Ajuste Kcal (%)</label><input type="number" id="ajusteKcal" value="0"></div>
            <div style="display:flex; align-items: flex-end;"><button class="btn btn-blue" style="width:100%" onclick="calcularTodo()"><i class="fa-solid fa-sync"></i> Calcular Presupuesto</button></div>
        </div>

        <div style="display:flex; gap:10px; margin-top:20px;">
            <button class="btn btn-ghost" onclick="toggle('secConfig')"><i class="fa-solid fa-sliders"></i> Configurar Ratios</button>
            <button class="btn btn-ghost" onclick="toggle('secResumen')"><i class="fa-solid fa-list-check"></i> Resumen por Comida</button>
        </div>

        <div id="secConfig" class="collapsible">
            <h3>Multiplicadores de Gasto y Macros</h3>
            <table>
                <tr><th>D√≠a</th><th>Gasto</th><th>Prot (g/kg)</th><th>Grasa (g/kg)</th><th style="color:var(--blue)">CH (g/kg) Info</th></tr>
                <tr><td>Alta</td><td><input type="number" id="mAlta" value="1.6" step="0.1"></td><td><input type="number" id="pAlta" value="2.0" step="0.1"></td><td><input type="number" id="gAlta" value="1.1" step="0.1"></td><td id="infoCH_Alta">-</td></tr>
                <tr><td>Media</td><td><input type="number" id="mMedia" value="1.45" step="0.1"></td><td><input type="number" id="pMedia" value="1.7" step="0.1"></td><td><input type="number" id="gMedia" value="1.1" step="0.1"></td><td id="infoCH_Media">-</td></tr>
                <tr><td>Baja</td><td><input type="number" id="mBaja" value="1.2" step="0.1"></td><td><input type="number" id="pBaja" value="1.4" step="0.1"></td><td><input type="number" id="gBaja" value="0.7" step="0.1"></td><td id="infoCH_Baja">-</td></tr>
            </table>
            <h3 style="margin-top:20px;">Reparto % por Comida</h3>
            <table>
                <tr><th>Comida</th><th>Prot %</th><th>Grasa %</th><th>CH %</th></tr>
                <tr><td>Desayuno</td><td><input type="number" id="rep_des_p" value="10"></td><td><input type="number" id="rep_des_g" value="10"></td><td><input type="number" id="rep_des_ch" value="27"></td></tr>
                <tr><td>Comida</td><td><input type="number" id="rep_com_p" value="39"></td><td><input type="number" id="rep_com_g" value="40"></td><td><input type="number" id="rep_com_ch" value="26"></td></tr>
                <tr><td>Merienda</td><td><input type="number" id="rep_mer_p" value="8"></td><td><input type="number" id="rep_mer_g" value="6"></td><td><input type="number" id="rep_mer_ch" value="17"></td></tr>
                <tr><td>Cena</td><td><input type="number" id="rep_cen_p" value="43"></td><td><input type="number" id="rep_cen_g" value="44"></td><td><input type="number" id="rep_cen_ch" value="30"></td></tr>
            </table>
        </div>

        <div id="secResumen" class="collapsible">
            <h3>Presupuesto Desglosado por Comida</h3>
            <div id="tablaResumenDetallada"></div>
        </div>
    </div>

    <div id="cardPlanner" class="card" style="display:none;">
        <h3><i class="fa-solid fa-calendar-day"></i> Dise√±o de Jornada</h3>
        <div class="grid-3">
            <div>
                <label>Tipo de D√≠a</label>
                <select id="tipoDiaSel" onchange="recalcularTodo()"><option value="Alta">üèîÔ∏è D√≠a Alta</option><option value="Media">üèÉ D√≠a Media</option><option value="Baja">üßò D√≠a Baja</option></select>
            </div>
            <div style="grid-column: span 2;">
                <label>Comidas a dise√±ar:</label>
                <div style="display:flex; gap:10px; flex-wrap:wrap; margin-top:10px;">
                    <label class="chip"><input type="checkbox" value="desayuno" onchange="toggleMealSection(this)"> Desayuno</label>
                    <label class="chip"><input type="checkbox" value="comida" onchange="toggleMealSection(this)"> Comida</label>
                    <label class="chip"><input type="checkbox" value="merienda" onchange="toggleMealSection(this)"> Merienda</label>
                    <label class="chip"><input type="checkbox" value="cena" onchange="toggleMealSection(this)"> Cena</label>
                </div>
            </div>
        </div>
    </div>

    <div id="mealContainer"></div>

    <div id="footerActions" class="card" style="display:none; text-align:right; background: var(--primary);">
        <button class="btn btn-success" onclick="exportarCSV()"><i class="fa-solid fa-file-export"></i> Descargar Plan Completo (CSV)</button>
    </div>
</div>

<script>
let dbAlimentos = [];
let mealsData = { desayuno: [], comida: [], merienda: [], cena: [] };
let presu = null;

window.onload = () => {
    fetch('alimentos.csv').then(r => r.text()).then(csv => {
        const lines = csv.split(/\r?\n/).filter(l => l.trim() !== "");
        dbAlimentos = lines.slice(1).map(l => {
            const c = l.split(/,(?=(?:(?:[^"]*"){2})*[^"]*$)/);
            return { n: c[0].replace(/"/g, '').trim(), kcal: pN(c[1]), p: pN(c[2]), g: pN(c[3]), ch: pN(c[4]) };
        }).filter(a => a.n !== "");
        document.getElementById('status').innerHTML = `<span style="color:var(--accent)">‚óè Base de Datos Conectada (${dbAlimentos.length} items)</span>`;
    });
};

function pN(v) { return parseFloat(v?.toString().replace(/"/g, '').replace(',', '.').trim()) || 0; }
function toggle(id) { const el = document.getElementById(id); el.style.display = el.style.display === 'block' ? 'none' : 'block'; }

function calcularTodo() {
    const p = pN(document.getElementById('peso').value);
    const h = pN(document.getElementById('altura').value);
    const e = pN(document.getElementById('edad').value);
    const g = document.getElementById('genero').value;
    const adj = 1 + (pN(document.getElementById('ajusteKcal').value) / 100);
    const bmr = (g === 'hombre') ? (10 * p + 6.25 * h - 5 * e + 5) : (10 * p + 6.25 * h - 5 * e - 161);
    
    presu = {};
    let html = `<table><tr><th>D√≠a / Comida</th><th>Kcal</th><th>P (g)</th><th>G (g)</th><th>CH (g)</th></tr>`;

    ['Alta', 'Media', 'Baja'].forEach(tipo => {
        const kcalT = bmr * pN(document.getElementById('m' + tipo).value) * adj;
        const pT = p * pN(document.getElementById('p' + tipo).value);
        const gT = p * pN(document.getElementById('g' + tipo).value);
        const chT = (kcalT - (pT * 4) - (gT * 9)) / 4;
        
        // Actualizar info CH g/kg
        document.getElementById('infoCH_'+tipo).innerText = (chT / p).toFixed(1) + " g/kg";

        presu[tipo] = { p: pT, g: gT, ch: chT, kcal: kcalT, meals: {} };
        html += `<tr class="row-day"><td>D√çA ${tipo.toUpperCase()}</td><td>${kcalT.toFixed(0)}</td><td>${pT.toFixed(0)}</td><td>${gT.toFixed(0)}</td><td>${chT.toFixed(0)}</td></tr>`;

        [['des','Desayuno'],['com','Comida'],['mer','Merienda'],['cen','Cena']].forEach(m => {
            const key = m[1].toLowerCase();
            const mP = pT * (pN(document.getElementById('rep_'+m[0]+'_p').value)/100);
            const mG = gT * (pN(document.getElementById('rep_'+m[0]+'_g').value)/100);
            const mCH = chT * (pN(document.getElementById('rep_'+m[0]+'_ch').value)/100);
            presu[tipo].meals[key] = { p: mP, g: mG, ch: mCH, kcal: (mP*4 + mG*9 + mCH*4) };
            const v = presu[tipo].meals[key];
            html += `<tr class="row-meal"><td>‚Ü≥ ${m[1]}</td><td>${v.kcal.toFixed(0)}</td><td>${v.p.toFixed(1)}</td><td>${v.g.toFixed(1)}</td><td>${v.ch.toFixed(1)}</td></tr>`;
        });
    });

    document.getElementById('tablaResumenDetallada').innerHTML = html + "</table>";
    document.getElementById('cardPlanner').style.display = 'block';
    document.getElementById('footerActions').style.display = 'block';
    recalcularTodo();
}

function toggleMealSection(cb) {
    const m = cb.value;
    if(cb.checked) {
        const html = `
            <div id="section_${m}" class="card">
                <div style="display:flex; justify-content:space-between; align-items:center; border-bottom:1px solid #f1f5f9; padding-bottom:10px; margin-bottom:15px;">
                    <h3 style="margin:0;"><i class="fa-solid fa-utensils"></i> ${m.toUpperCase()}</h3>
                    <div id="target_${m}" style="font-size:0.7rem; font-weight:800; color:var(--blue)"></div>
                </div>
                <div class="grid-3" style="margin-bottom:15px;">
                    <div style="grid-column: span 2;">
                        <input type="text" id="bus_${m}" list="list_${m}" placeholder="M√≠nimo 3 letras..." oninput="filtrar('${m}', this.value)" onkeypress="if(event.key==='Enter') a√±adir('${m}')">
                        <datalist id="list_${m}"></datalist>
                    </div>
                    <button class="btn btn-blue" onclick="a√±adir('${m}')"><i class="fa-solid fa-plus"></i> A√±adir</button>
                </div>
                <div id="res_${m}"></div>
            </div>`;
        document.getElementById('mealContainer').insertAdjacentHTML('beforeend', html);
        renderMeal(m);
    } else {
        document.getElementById('section_'+m)?.remove();
        mealsData[m] = [];
    }
}

function filtrar(m, q) {
    const dl = document.getElementById('list_'+m);
    if(q.length < 3) { dl.innerHTML = ""; return; }
    const matches = dbAlimentos.filter(a => a.n.toLowerCase().includes(q.toLowerCase())).slice(0,10);
    dl.innerHTML = matches.map(a => `<option value="${a.n}">`).join('');
}

function a√±adir(m) {
    const input = document.getElementById('bus_'+m);
    const item = dbAlimentos.find(a => a.n === input.value);
    if(item) {
        mealsData[m].push({...item, gramos: 100, manual: false});
        input.value = "";
        renderMeal(m);
    }
}

function renderMeal(m) {
    const dia = document.getElementById('tipoDiaSel').value;
    const target = presu[dia].meals[m];
    const data = mealsData[m];

    if(data.length > 0) {
        for(let i=0; i<2500; i++) {
            let cP=0, cCH=0;
            data.forEach(s => { cP += s.p*s.gramos/100; cCH += s.ch*s.gramos/100; });
            let eP = target.p - cP, eCH = target.ch - cCH;
            data.forEach(s => {
                if(s.manual) return;
                let sP = s.p > 10 ? s.p/100 : 0.05, sCH = s.ch > 15 ? s.ch/100 : 0.05;
                s.gramos += (eP * sP + eCH * sCH) * 0.1;
                if(s.gramos < 0) s.gramos = 0;
            });
        }
    }

    let tP=0, tG=0, tCH=0, tK=0;
    let rows = data.map((s, i) => {
        const sp=s.p*s.gramos/100, sg=s.g*s.gramos/100, sch=s.ch*s.gramos/100, sk=s.kcal*s.gramos/100;
        tP+=sp; tG+=sg; tCH+=sch; tK+=sk;
        return `<tr><td style="text-align:left; font-weight:600">${s.n}</td>
            <td><input type="number" class="input-gramos ${s.manual?'locked':''}" value="${Math.round(s.gramos)}" onchange="mealsData['${m}'][${i}].gramos=pN(this.value);mealsData['${m}'][${i}].manual=true;renderMeal('${m}')"></td>
            <td>${sp.toFixed(1)}</td><td>${sg.toFixed(1)}</td><td>${sch.toFixed(1)}</td>
            <td><i class="fa-solid fa-trash" style="color:var(--error); cursor:pointer" onclick="mealsData['${m}'].splice(${i},1);renderMeal('${m}')"></i></td></tr>`;
    }).join('');

    const dP=tP-target.p, dG=tG-target.g, dCH=tCH-target.ch, dK=tK-target.kcal;
    document.getElementById('target_'+m).innerHTML = `OBJ: ${target.kcal.toFixed(0)} kcal | P:${target.p.toFixed(0)} G:${target.g.toFixed(0)} CH:${target.ch.toFixed(0)}`;
    document.getElementById('res_'+m).innerHTML = `
        <table>
            <tr><th>Alimento</th><th>Gramos</th><th>P</th><th>G</th><th>CH</th><th></th></tr>
            ${rows}
            <tr class="row-day"><td>TOTAL</td>
                <td>${tK.toFixed(0)} <span class="deviation ${Math.abs(dK)<20?'dev-ok':'dev-err'}">(${dK>0?'+':''}${dK.toFixed(0)})</span></td>
                <td>${tP.toFixed(1)} <span class="deviation ${Math.abs(dP)<2?'dev-ok':'dev-err'}">(${dP>0?'+':''}${dP.toFixed(1)})</span></td>
                <td>${tG.toFixed(1)} <span class="deviation ${Math.abs(dG)<2?'dev-ok':'dev-err'}">(${dG>0?'+':''}${dG.toFixed(1)})</span></td>
                <td>${tCH.toFixed(1)} <span class="deviation ${Math.abs(dCH)<2?'dev-ok':'dev-err'}">(${dCH>0?'+':''}${dCH.toFixed(1)})</span></td>
                <td></td></tr>
        </table>`;
}

function recalcularTodo() { Object.keys(mealsData).forEach(m => { if(document.getElementById('section_'+m)) renderMeal(m); }); }

function exportarCSV() {
    let csv = "\uFEFFD√≠a,Comida,Alimento,Gramos,Kcal,Proteina,Grasa,CH\n";
    const dia = document.getElementById('tipoDiaSel').value;
    Object.keys(mealsData).forEach(m => {
        mealsData[m].forEach(s => {
            const g = Math.round(s.gramos);
            csv += `${dia},${m},"${s.n}",${g},${(s.kcal*g/100).toFixed(1)},${(s.p*g/100).toFixed(1)},${(s.g*g/100).toFixed(1)},${(s.ch*g/100).toFixed(1)}\n`;
        });
    });
    const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
    const link = document.createElement("a");
    link.href = URL.createObjectURL(blob);
    link.download = `Plan_Jornada_${dia}.csv`;
    link.click();
}
</script>
</body>
</html>
