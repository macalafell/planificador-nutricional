<script>
let db = [];
let seleccionados = [];
let objetivosGlobales = null;

const REPARTOS = { 
    desayuno: {p:0.1, g:0.1, ch:0.27}, 
    comida: {p:0.39, g:0.4, ch:0.26}, 
    merienda: {p:0.08, g:0.06, ch:0.17}, 
    cena: {p:0.43, g:0.44, ch:0.3} 
};

// CARGA BLINDADA POR POSICIÓN (No por nombre)
fetch('alimentos.csv').then(r => r.text()).then(t => {
    const filas = t.split(/\r?\n/).filter(linea => linea.trim() !== "");
    
    // Empezamos en la fila 1 para saltar cabeceras
    db = filas.slice(1).map(f => {
        // Detectamos si usas coma o punto y coma
        const separador = f.includes(';') ? ';' : ',';
        const c = f.split(separador);
        
        return { 
            n: c[0] ? c[0].trim() : "", 
            kcal: parseFloat(String(c[1]).replace(',', '.')) || 0, // Columna 2
            p: parseFloat(String(c[2]).replace(',', '.')) || 0,    // Columna 3
            g: parseFloat(String(c[3]).replace(',', '.')) || 0,    // Columna 4
            ch: parseFloat(String(c[4]).replace(',', '.')) || 0    // Columna 5
        };
    }).filter(a => a.n);

    document.getElementById('listaAlimentos').innerHTML = db.map(a => `<option value="${a.n}">`).join('');
    document.getElementById('status').innerText = `✅ ${db.length} alimentos cargados (Proteína y CH vinculados).`;
});

function calcularObjetivos() {
    const p = parseFloat(document.getElementById('peso').value);
    const a = parseFloat(document.getElementById('altura').value);
    const e = parseFloat(document.getElementById('edad').value);
    const g = document.getElementById('genero').value;
    const aj = 1 + (parseFloat(document.getElementById('ajuste').value)/100);
    
    const bmr = (g === 'hombre') ? (10*p + 6.25*a - 5*e + 5) : (10*p + 6.25*a - 5*e - 161);
    
    objetivosGlobales = {};
    let html = `<table><tr><th>Día / Comida</th><th>Kcal</th><th>P (g)</th><th>G (g)</th><th>CH (g)</th></tr>`;
    
    const config = [
        {id:'Alta', m: parseFloat(document.getElementById('mAlta').value), rp:2.0, rg:1.1},
        {id:'Media', m: parseFloat(document.getElementById('mMedia').value), rp:1.7, rg:1.1},
        {id:'Baja', m: parseFloat(document.getElementById('mBaja').value), rp:1.4, rg:0.7}
    ];
    
    config.forEach(d => {
        const kcalT = Math.round(bmr * d.m * aj);
        const pT = p * d.rp;
        const gT = p * d.rg;
        const chT = (kcalT - (pT*4) - (gT*9)) / 4;
        
        objetivosGlobales[d.id] = { p: pT, g: gT, ch: chT, kcal: kcalT, c: {} };
        
        html += `<tr class="total-row"><td>TOTAL ${d.id}</td><td>${kcalT}</td><td>${pT.toFixed(0)}</td><td>${gT.toFixed(0)}</td><td>${chT.toFixed(0)}</td></tr>`;
        
        for(let comida in REPARTOS) {
            const m = REPARTOS[comida];
            // FIX: Cálculo de kcal por comida basado en el reparto de macros
            const cP = pT * m.p;
            const cG = gT * m.g;
            const cCH = chT * m.ch;
            const cKcal = Math.round((cP * 4) + (cG * 9) + (cCH * 4));

            objetivosGlobales[d.id].c[comida] = { p: cP, g: cG, ch: cCH, kcal: cKcal };
            
            html += `<tr><td>↳ ${comida}</td><td>${cKcal}</td><td>${cP.toFixed(1)}</td><td>${cG.toFixed(1)}</td><td>${cCH.toFixed(1)}</td></tr>`;
        }
    });
    
    document.getElementById('tablaResumen').innerHTML = html + `</table>`;
    document.getElementById('resultados').style.display = 'block';
    document.getElementById('seccionPlanificador').style.display = 'block';
}

function generarRecetaDetallada() {
    const d = document.getElementById('tipoDiaSel').value;
    const c = document.getElementById('comidaSel').value;
    const obj = objetivosGlobales[d].c[c];

    // Solver (Iteración para ajustar gramos)
    for(let i=0; i<1000; i++) {
        let curP=0, curG=0, curCH=0;
        seleccionados.forEach(s => {
            curP += (s.p * s.gramos / 100);
            curG += (s.g * s.gramos / 100);
            curCH += (s.ch * s.gramos / 100);
        });
        seleccionados.forEach(s => {
            let error = ((obj.p - curP)*(s.p/10) + (obj.g - curG)*(s.g/10) + (obj.ch - curCH)*(s.ch/10)) / 50;
            s.gramos = Math.max(2, s.gramos + error);
        });
    }

    // Renderizado de Tabla Detallada
    let finalP=0, finalG=0, finalCH=0, finalKcal=0;
    let resHtml = `<div class="receta-res"><h3>RECETA DETALLADA: ${c.toUpperCase()}</h3>`;
    resHtml += `<table><tr><th>Alimento</th><th>Cant.</th><th>Kcal</th><th>P</th><th>G</th><th>CH</th></tr>`;
    
    seleccionados.forEach(s => {
        const pAl = (s.p * s.gramos / 100);
        const gAl = (s.g * s.gramos / 100);
        const chAl = (s.ch * s.gramos / 100);
        const kcalAl = (s.kcal * s.gramos / 100);
        
        finalP += pAl; finalG += gAl; finalCH += chAl; finalKcal += kcalAl;
        
        resHtml += `<tr>
            <td>${s.n}</td>
            <td><b>${Math.round(s.gramos)}g</b></td>
            <td>${Math.round(kcalAl)}</td>
            <td>${pAl.toFixed(1)}</td>
            <td>${gAl.toFixed(1)}</td>
            <td>${chAl.toFixed(1)}</td>
        </tr>`;
    });

    resHtml += `<tr class="total-row"><td>TOTAL REAL</td><td>-</td><td>${Math.round(finalKcal)}</td><td>${finalP.toFixed(1)}</td><td>${finalG.toFixed(1)}</td><td>${finalCH.toFixed(1)}</td></tr>`;
    document.getElementById('resultadoReceta').innerHTML = resHtml + `</table></div>`;
}

// Funciones auxiliares (renderTags y añadirAlimento se mantienen igual)
function añadirAlimento() {
    const val = document.getElementById('buscador').value;
    const item = db.find(x => x.n === val);
    if(item) {
        seleccionados.push({...item, gramos: 100});
        document.getElementById('buscador').value = '';
        renderTags();
    }
}
function renderTags() {
    document.getElementById('tagsIngredientes').innerHTML = seleccionados.map((s, i) => 
        `<span class="tag">${s.n} <b onclick="seleccionados.splice(${i},1);renderTags()">✕</b></span>`).join('');
}
</script>
