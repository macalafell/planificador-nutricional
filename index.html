<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Planificador Nutricional Pro | Miquel</title>
    <style>
        :root { --primary: #2c3e50; --accent: #27ae60; --bg: #f4f7f6; }
        body { font-family: 'Segoe UI', sans-serif; background: var(--bg); color: var(--primary); padding: 20px; }
        .container { max-width: 1000px; margin: 0 auto; background: white; padding: 30px; border-radius: 12px; box-shadow: 0 4px 20px rgba(0,0,0,0.1); }
        .section { margin-bottom: 30px; padding: 20px; border: 1px solid #eee; border-radius: 8px; }
        .grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 15px; margin-bottom: 20px; }
        label { font-weight: bold; font-size: 0.85rem; display: block; margin-bottom: 5px; }
        input, select { width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 5px; box-sizing: border-box; }
        button { background: var(--accent); color: white; border: none; padding: 12px; border-radius: 5px; cursor: pointer; font-weight: bold; width: 100%; transition: 0.3s; }
        button:hover { background: #219150; }
        
        /* Tablas Estilo Contable */
        table { width: 100%; border-collapse: collapse; margin-top: 15px; }
        th, td { border: 1px solid #eee; padding: 10px; text-align: center; font-size: 0.9rem; }
        th { background: var(--primary); color: white; }
        tr:nth-child(even) { background: #f9f9f9; }
        .total-row { background: #e8f5e9 !important; font-weight: bold; }

        .tag-container { display: flex; flex-wrap: wrap; gap: 8px; margin: 15px 0; }
        .tag { background: #e2e8f0; padding: 6px 12px; border-radius: 15px; font-size: 0.85rem; }
        .tag b { margin-left: 8px; color: #e53e3e; cursor: pointer; }
        .receta-res { margin-top: 20px; padding: 20px; border: 2px solid var(--accent); border-radius: 8px; background: #fff; }
    </style>
</head>
<body>

<div class="container">
    <h1>üçé SISTEMA DE NUTRICI√ìN CIENT√çFICO</h1>
    <div id="status" style="color: var(--accent); font-weight: bold; margin-bottom: 15px;">Cargando base de datos...</div>

    <div class="section">
        <h2>1. Perfil y Actividad</h2>
        <div class="grid">
            <div><label>Peso (kg)</label><input type="number" id="peso" value="75"></div>
            <div><label>Altura (cm)</label><input type="number" id="altura" value="180"></div>
            <div><label>Edad</label><input type="number" id="edad" value="34"></div>
            <div>
                <label>G√©nero</label>
                <select id="genero"><option value="hombre">Hombre</option><option value="mujer">Mujer</option></select>
            </div>
        </div>
        <div class="grid">
            <div><label>Mult. Alta</label><input type="number" id="mAlta" value="1.6" step="0.1"></div>
            <div><label>Mult. Media</label><input type="number" id="mMedia" value="1.45" step="0.1"></div>
            <div><label>Mult. Baja</label><input type="number" id="mBaja" value="1.2" step="0.1"></div>
            <div><label>Ajuste %</label><input type="number" id="ajuste" value="0"></div>
        </div>
        <button onclick="calcularObjetivos()">PASO A: CALCULAR OBJETIVOS DIARIOS</button>
    </div>

    <div id="resultados" class="section" style="display:none;">
        <h2>2. Desglose de Objetivos por Comida</h2>
        <div id="tablaResumen"></div>
    </div>

    <div id="seccionPlanificador" class="section" style="display:none;">
        <h2>3. Dise√±ador de Receta con Detalle</h2>
        <div class="grid">
            <div>
                <label>Nivel de Actividad</label>
                <select id="tipoDiaSel"><option value="Alta">D√≠a Alta Intensidad</option><option value="Media">D√≠a Media Intensidad</option><option value="Baja">D√≠a Baja Intensidad</option></select>
            </div>
            <div>
                <label>Comida</label>
                <select id="comidaSel"><option value="desayuno">Desayuno</option><option value="comida">Comida</option><option value="merienda">Merienda</option><option value="cena">Cena</option></select>
            </div>
        </div>
        <div style="margin-top: 15px;">
            <label>Seleccionar Alimentos</label>
            <input type="text" id="buscador" list="listaAlimentos" placeholder="Escribe y a√±ade...">
            <datalist id="listaAlimentos"></datalist>
            <button onclick="a√±adirAlimento()" style="background: var(--primary); margin-top: 10px;">A√ëADIR A LA LISTA</button>
        </div>
        <div id="tagsIngredientes" class="tag-container"></div>
        <button onclick="generarRecetaDetallada()" style="background:#2980b9;">PASO B: GENERAR CANTIDADES Y TABLA</button>
        <div id="resultadoReceta"></div>
    </div>
</div>

<script>
let db = [];
let seleccionados = [];
let objetivosGlobales = null;

const REPARTOS = { 
    desayuno: {p:0.1, g:0.1, ch:0.27}, 
    comida: {p:0.39, g:0.4, ch:0.26}, 
    merienda: {p:0.08, g:0.06, ch:0.17}, 
    cena: {p:0.43, g:0.44, ch:0.3} 
};

// Carga robusta del CSV
fetch('alimentos.csv').then(r => r.text()).then(t => {
    const filas = t.split(/\r?\n/).filter(linea => linea.trim() !== "");
    db = filas.slice(1).map(f => {
        const c = f.split(/[;,]/);
        // Limpiamos espacios y aseguramos que sean n√∫meros
        return { 
            n: c[0].trim(), 
            kcal: parseFloat(c[1]) || 0, 
            p: parseFloat(c[2]) || 0, 
            g: parseFloat(c[3]) || 0, 
            ch: parseFloat(c[4]) || 0 
        };
    }).filter(a => a.n);
    document.getElementById('listaAlimentos').innerHTML = db.map(a => `<option value="${a.n}">`).join('');
    document.getElementById('status').innerText = `‚úÖ ${db.length} alimentos listos en base de datos.`;
});

function calcularObjetivos() {
    const p = parseFloat(document.getElementById('peso').value);
    const a = parseFloat(document.getElementById('altura').value);
    const e = parseFloat(document.getElementById('edad').value);
    const g = document.getElementById('genero').value;
    const aj = 1 + (parseFloat(document.getElementById('ajuste').value)/100);
    
    const bmr = (g === 'hombre') ? (10*p + 6.25*a - 5*e + 5) : (10*p + 6.25*a - 5*e - 161);
    
    objetivosGlobales = {};
    let html = `<table><tr><th>D√≠a / Comida</th><th>Kcal</th><th>P (g)</th><th>G (g)</th><th>CH (g)</th></tr>`;
    
    const config = [
        {id:'Alta', m: parseFloat(document.getElementById('mAlta').value), rp:2.0, rg:1.1},
        {id:'Media', m: parseFloat(document.getElementById('mMedia').value), rp:1.7, rg:1.1},
        {id:'Baja', m: parseFloat(document.getElementById('mBaja').value), rp:1.4, rg:0.7}
    ];
    
    config.forEach(d => {
        const kcalT = Math.round(bmr * d.m * aj);
        const pT = p * d.rp;
        const gT = p * d.rg;
        const chT = (kcalT - (pT*4) - (gT*9)) / 4;
        
        objetivosGlobales[d.id] = { p: pT, g: gT, ch: chT, kcal: kcalT, c: {} };
        
        html += `<tr class="total-row"><td>D√≠a ${d.id}</td><td>${kcalT}</td><td>${pT.toFixed(0)}</td><td>${gT.toFixed(0)}</td><td>${chT.toFixed(0)}</td></tr>`;
        
        for(let comida in REPARTOS) {
            const m = REPARTOS[comida];
            const objC = { p: pT*m.p, g: gT*m.g, ch: chT*m.ch, kcal: Math.round(kcalT * ((m.p + m.g + m.ch)/3)) };
            objetivosGlobales[d.id].c[comida] = objC;
            html += `<tr><td>‚Ü≥ ${comida}</td><td>${objC.kcal}</td><td>${objC.p.toFixed(1)}</td><td>${objC.g.toFixed(1)}</td><td>${objC.ch.toFixed(1)}</td></tr>`;
        }
    });
    
    document.getElementById('tablaResumen').innerHTML = html + `</table>`;
    document.getElementById('resultados').style.display = 'block';
    document.getElementById('seccionPlanificador').style.display = 'block';
}

function a√±adirAlimento() {
    const val = document.getElementById('buscador').value;
    const item = db.find(x => x.n === val);
    if(item) {
        seleccionados.push({...item, gramos: 100});
        document.getElementById('buscador').value = '';
        renderTags();
    }
}

function renderTags() {
    document.getElementById('tagsIngredientes').innerHTML = seleccionados.map((s, i) => 
        `<span class="tag">${s.n} <b onclick="seleccionados.splice(${i},1);renderTags()">‚úï</b></span>`).join('');
}

function generarRecetaDetallada() {
    const d = document.getElementById('tipoDiaSel').value;
    const c = document.getElementById('comidaSel').value;
    const obj = objetivosGlobales[d].c[c];

    // Solver Cient√≠fico
    for(let i=0; i<1500; i++) {
        let curP=0, curG=0, curCH=0;
        seleccionados.forEach(s => {
            curP += (s.p * s.gramos / 100);
            curG += (s.g * s.gramos / 100);
            curCH += (s.ch * s.gramos / 100);
        });
        seleccionados.forEach(s => {
            let diff = ((obj.p - curP)*(s.p/10) + (obj.g - curG)*(s.g/10) + (obj.ch - curCH)*(s.ch/10)) / 100;
            s.gramos = Math.max(5, s.gramos + diff);
        });
    }

    // Tabla de Detalle por Alimento
    let finalP=0, finalG=0, finalCH=0, finalKcal=0;
    let resHtml = `<div class="receta-res"><h3>Receta: ${c.toUpperCase()} (${d})</h3>`;
    resHtml += `<p style="font-size:0.85rem; color:#666;">Objetivo: P:${obj.p.toFixed(1)} | G:${obj.g.toFixed(1)} | CH:${obj.ch.toFixed(1)}</p>`;
    
    resHtml += `<table><tr><th>Alimento</th><th>Cant.</th><th>Kcal</th><th>P</th><th>G</th><th>CH</th></tr>`;
    
    seleccionados.forEach(s => {
        const pAl = (s.p * s.gramos / 100);
        const gAl = (s.g * s.gramos / 100);
        const chAl = (s.ch * s.gramos / 100);
        const kcalAl = (s.kcal * s.gramos / 100);
        finalP += pAl; finalG += gAl; finalCH += chAl; finalKcal += kcalAl;
        
        resHtml += `<tr>
            <td>${s.n}</td>
            <td><b>${Math.round(s.gramos)}g</b></td>
            <td>${Math.round(kcalAl)}</td>
            <td>${pAl.toFixed(1)}</td>
            <td>${gAl.toFixed(1)}</td>
            <td>${chAl.toFixed(1)}</td>
        </tr>`;
    });

    resHtml += `<tr class="total-row"><td>TOTAL REAL</td><td>-</td><td>${Math.round(finalKcal)}</td><td>${finalP.toFixed(1)}</td><td>${finalG.toFixed(1)}</td><td>${finalCH.toFixed(1)}</td></tr>`;
    document.getElementById('resultadoReceta').innerHTML = resHtml + `</table></div>`;
}
</script>
</body>
</html>
