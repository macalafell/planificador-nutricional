<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Planificador Nutricional Trail - Miquel</title>
    <style>
        :root { --primary: #0f172a; --accent: #10b981; --warning: #f59e0b; --bg: #f8fafc; }
        body { font-family: 'Inter', system-ui, sans-serif; background: var(--bg); color: var(--primary); padding: 20px; line-height: 1.6; }
        .container { max-width: 900px; margin: 0 auto; background: white; padding: 40px; border-radius: 16px; box-shadow: 0 10px 15px -3px rgba(0,0,0,0.1); }
        .section { margin-bottom: 40px; padding: 25px; border: 1px solid #e2e8f0; border-radius: 12px; }
        h1 { font-size: 1.8rem; border-bottom: 3px solid var(--accent); display: inline-block; margin-bottom: 30px; }
        .grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 20px; margin-bottom: 20px; }
        label { font-weight: 700; font-size: 0.9rem; color: #64748b; display: block; margin-bottom: 8px; }
        input, select { width: 100%; padding: 12px; border: 2px solid #e2e8f0; border-radius: 8px; font-size: 1rem; transition: border-color 0.2s; }
        input:focus { border-color: var(--accent); outline: none; }
        button { background: #3b82f6; color: white; border: none; padding: 15px; border-radius: 8px; cursor: pointer; font-weight: 800; width: 100%; text-transform: uppercase; margin-top: 10px; }
        button:hover { filter: brightness(1.1); }
        #status { padding: 15px; border-radius: 8px; margin-bottom: 20px; font-weight: bold; background: #fffbeb; border: 1px solid #fef3c7; color: #92400e; }
        table { width: 100%; border-collapse: collapse; margin-top: 20px; }
        th, td { padding: 12px; border: 1px solid #e2e8f0; text-align: center; }
        th { background: #f1f5f9; color: #475569; }
        .total-row { background: #ecfdf5; font-weight: bold; }
        .tag { background: #e2e8f0; padding: 5px 12px; border-radius: 20px; display: inline-flex; align-items: center; margin: 5px; font-size: 0.9rem; }
        .tag b { margin-left: 8px; color: #ef4444; cursor: pointer; }
    </style>
</head>
<body>

<div class="container">
    <h1>üèîÔ∏è Sistema de Nutrici√≥n Cient√≠fico</h1>
    
    <div id="status">‚è≥ Cargando base de datos alimentos.csv...</div>

    <div class="section">
        <div class="grid">
            <div><label>Peso (kg)</label><input type="number" id="peso" value="75"></div>
            <div><label>Altura (cm)</label><input type="number" id="altura" value="180"></div>
            <div><label>Edad</label><input type="number" id="edad" value="35"></div>
            <div><label>G√©nero</label><select id="genero"><option value="hombre">Hombre</option><option value="mujer">Mujer</option></select></div>
        </div>
        <div class="grid">
            <div><label>Mult. Alta</label><input type="number" id="mAlta" value="1.6" step="0.05"></div>
            <div><label>Mult. Media</label><input type="number" id="mMedia" value="1.45" step="0.05"></div>
            <div><label>Mult. Baja</label><input type="number" id="mBaja" value="1.2" step="0.05"></div>
        </div>
        <button onclick="calcularObjetivos()">Paso A: Calcular Objetivos Macro</button>
    </div>

    <div id="resumenMacros" style="display:none;" class="section">
        <h2>2. Desglose de Objetivos por Comida</h2>
        <div id="tablaMacros"></div>
    </div>

    <div id="seccionReceta" style="display:none;" class="section">
        <h2>3. Dise√±ador de Receta Exacta</h2>
        <div class="grid">
            <div><label>Tipo de D√≠a</label><select id="tipoDiaSel"><option value="Alta">D√≠a Alta</option><option value="Media">D√≠a Media</option><option value="Baja">D√≠a Baja</option></select></div>
            <div><label>Comida</label><select id="comidaSel"><option value="desayuno">Desayuno</option><option value="comida">Comida</option><option value="merienda">Merienda</option><option value="cena">Cena</option></select></div>
        </div>
        <div style="margin-bottom: 15px;">
            <label>Buscar Alimento</label>
            <input type="text" id="buscador" list="listaAlimentos" placeholder="Escribe para buscar...">
            <datalist id="listaAlimentos"></datalist>
            <button onclick="a√±adirAlimento()" style="background: #64748b;">A√±adir a la Receta</button>
        </div>
        <div id="listaTags"></div>
        <button onclick="generarReceta()" style="background: #10b981; margin-top: 20px;">Paso B: Generar Gramos Exactos</button>
        
        <div id="resultadoFinal" style="margin-top: 25px;"></div>
    </div>
</div>

<script>
// --- L√ìGICA DE DATOS ---
let dbAlimentos = [];
let seleccionados = [];
let macrosCalculados = null;

const REPARTO_HORECA = {
    desayuno: { p: 0.10, g: 0.10, ch: 0.27 },
    comida:   { p: 0.39, g: 0.40, ch: 0.26 },
    merienda: { p: 0.08, g: 0.06, ch: 0.17 },
    cena:     { p: 0.43, g: 0.44, ch: 0.30 }
};

// Carga del CSV con Parser Robusto para Formato Espa√±a
window.onload = () => {
    fetch('alimentos.csv')
        .then(res => res.text())
        .then(csv => {
            const lineas = csv.split(/\r?\n/).filter(line => line.trim() !== "");
            dbAlimentos = lineas.slice(1).map(line => {
                // Separamos por coma pero limpiamos comillas y gestionamos el decimal
                const cols = line.split(/,(?=(?:(?:[^"]*"){2})*[^"]*$)/); 
                return {
                    n: cols[0].replace(/"/g, '').trim(),
                    kcal: limpiar(cols[1]),
                    p: limpiar(cols[2]),
                    g: limpiar(cols[3]),
                    ch: limpiar(cols[4])
                };
            }).filter(a => a.n !== "");

            document.getElementById('listaAlimentos').innerHTML = dbAlimentos.map(a => `<option value="${a.n}">`).join('');
            document.getElementById('status').innerHTML = "‚úÖ Base de datos cargada correctamente.";
            document.getElementById('status').style.background = "#f0fdf4";
            document.getElementById('status').style.color = "#166534";
        })
        .catch(e => {
            document.getElementById('status').innerHTML = "‚ùå Error: No se pudo cargar alimentos.csv";
        });
};

function limpiar(val) {
    if(!val) return 0;
    // Quitamos comillas, cambiamos coma por punto y parseamos
    let n = val.replace(/"/g, '').replace(',', '.').trim();
    return parseFloat(n) || 0;
}

// --- C√ÅLCULOS BIOM√âTRICOS ---
function calcularObjetivos() {
    const peso = parseFloat(document.getElementById('peso').value);
    const altura = parseFloat(document.getElementById('altura').value);
    const edad = parseFloat(document.getElementById('edad').value);
    const genero = document.getElementById('genero').value;

    const bmr = (genero === 'hombre') ? (10 * peso + 6.25 * altura - 5 * edad + 5) : (10 * peso + 6.25 * altura - 5 * edad - 161);

    const configs = [
        { id: 'Alta', m: parseFloat(document.getElementById('mAlta').value), rp: 2, rg: 1.1 },
        { id: 'Media', m: parseFloat(document.getElementById('mMedia').value), rp: 1.7, rg: 1.1 },
        { id: 'Baja', m: parseFloat(document.getElementById('mBaja').value), rp: 1.4, rg: 0.7 }
    ];

    macrosCalculados = {};
    let html = `<table><tr><th>Comida</th><th>Prot</th><th>Grasa</th><th>CH</th></tr>`;

    configs.forEach(c => {
        const kcalTotal = bmr * c.m;
        const pTotal = peso * c.rp;
        const gTotal = peso * c.rg;
        const chTotal = (kcalTotal - (pTotal * 4) - (gTotal * 9)) / 4;

        macrosCalculados[c.id] = { p: pTotal, g: gTotal, ch: chTotal, comidas: {} };

        html += `<tr class="total-row"><td>D√≠a ${c.id}</td><td>${pTotal.toFixed(0)}g</td><td>${gTotal.toFixed(0)}g</td><td>${chTotal.toFixed(0)}g</td></tr>`;

        for (let com in REPARTO_HORECA) {
            const r = REPARTO_HORECA[com];
            macrosCalculados[c.id].comidas[com] = { p: pTotal * r.p, g: gTotal * r.g, ch: chTotal * r.ch };
            html += `<tr><td>&nbsp;&nbsp;‚Ü≥ ${com}</td><td>${(pTotal * r.p).toFixed(1)}</td><td>${(gTotal * r.g).toFixed(1)}</td><td>${(chTotal * r.ch).toFixed(1)}</td></tr>`;
        }
    });

    document.getElementById('tablaMacros').innerHTML = html + "</table>";
    document.getElementById('resumenMacros').style.display = 'block';
    document.getElementById('seccionReceta').style.display = 'block';
}

// --- GESTI√ìN DE RECETA ---
function a√±adirAlimento() {
    const nombre = document.getElementById('buscador').value;
    const item = dbAlimentos.find(a => a.n === nombre);
    if(item) {
        seleccionados.push({...item, gramos: 100});
        document.getElementById('buscador').value = "";
        actualizarTags();
    }
}

function actualizarTags() {
    document.getElementById('listaTags').innerHTML = seleccionados.map((s, i) => `
        <span class="tag">${s.n} <b onclick="seleccionados.splice(${i},1);actualizarTags();">‚úï</b></span>
    `).join('');
}

function generarReceta() {
    if(seleccionados.length === 0) return;
    
    const dia = document.getElementById('tipoDiaSel').value;
    const comida = document.getElementById('comidaSel').value;
    const obj = macrosCalculados[dia].comidas[comida];

    // Algoritmo de ajuste progresivo (Solver)
    for(let i=0; i<3000; i++) {
        let curP = 0, curG = 0, curCH = 0;
        seleccionados.forEach(s => {
            curP += (s.p * s.gramos / 100);
            curG += (s.g * s.gramos / 100);
            curCH += (s.ch * s.gramos / 100);
        });

        let errCH = obj.ch - curCH;
        let errP = obj.p - curP;

        seleccionados.forEach(s => {
            // Priorizamos CH en alimentos con alta densidad de CH (como el pan)
            let factor = (s.ch > 20) ? 2.5 : 0.5;
            s.gramos += (errCH * (s.ch/100) * factor + errP * (s.p/100)) * 0.1;
            if(s.gramos < 5) s.gramos = 5;
        });
    }

    // Mostrar Resultado
    let resHtml = `<h3>Resultado para ${comida.toUpperCase()}</h3><table><tr><th>Alimento</th><th>Cantidad</th><th>P</th><th>G</th><th>CH</th></tr>`;
    let tP=0, tG=0, tCH=0;

    seleccionados.forEach(s => {
        const sp = (s.p * s.gramos / 100);
        const sg = (s.g * s.gramos / 100);
        const sch = (s.ch * s.gramos / 100);
        tP += sp; tG += sg; tCH += sch;
        resHtml += `<tr><td>${s.n}</td><td><b>${Math.round(s.gramos)}g</b></td><td>${sp.toFixed(1)}</td><td>${sg.toFixed(1)}</td><td>${sch.toFixed(1)}</td></tr>`;
    });

    resHtml += `<tr class="total-row"><td>TOTAL</td><td>-</td><td>${tP.toFixed(1)}</td><td>${tG.toFixed(1)}</td><td>${tCH.toFixed(1)}</td></tr>`;
    resHtml += `</table><p style="font-size:0.8rem; color:gray;">Objetivo Te√≥rico: P:${obj.p.toFixed(1)} | G:${obj.g.toFixed(1)} | CH:${obj.ch.toFixed(1)}</p>`;
    
    document.getElementById('resultadoFinal').innerHTML = resHtml;
}
</script>

</body>
</html>
