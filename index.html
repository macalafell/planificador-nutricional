<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Planificador Nutricional Trail - Miquel V3.0</title>
    <style>
        :root { --primary: #0f172a; --accent: #10b981; --warning: #f59e0b; --bg: #f1f5f9; --error: #ef4444; --blue: #3b82f6; }
        body { font-family: 'Inter', system-ui, sans-serif; background: var(--bg); color: var(--primary); padding: 20px; line-height: 1.5; }
        .container { max-width: 1200px; margin: 0 auto; }
        .card { background: white; padding: 25px; border-radius: 12px; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1); margin-bottom: 25px; border: 1px solid #e2e8f0; }
        h1 { font-size: 1.6rem; border-left: 5px solid var(--accent); padding-left: 15px; margin-bottom: 25px; }
        h3 { margin-top: 0; color: #334155; font-size: 1rem; text-transform: uppercase; border-bottom: 1px solid #eee; padding-bottom: 10px; margin-bottom: 20px; }
        
        .grid-config { display: grid; grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); gap: 15px; margin-bottom: 15px; }
        label { font-weight: 700; font-size: 0.75rem; color: #64748b; display: block; margin-bottom: 5px; text-transform: uppercase; }
        input, select { width: 100%; padding: 8px; border: 1px solid #cbd5e1; border-radius: 6px; font-size: 0.9rem; }
        
        .reparto-table input { width: 60px; text-align: center; padding: 4px; }
        .meal-selector { display: flex; gap: 15px; flex-wrap: wrap; margin: 20px 0; padding: 15px; background: #f8fafc; border-radius: 8px; }
        .meal-checkbox { display: flex; align-items: center; gap: 8px; font-weight: 600; cursor: pointer; }

        .meal-section { border-top: 4px solid var(--blue); margin-top: 20px; }
        .meal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; }
        
        table { width: 100%; border-collapse: collapse; font-size: 0.85rem; }
        th, td { padding: 10px; border: 1px solid #e2e8f0; text-align: center; }
        th { background: #f8fafc; color: #64748b; }
        .total-row { background: #f1f5f9; font-weight: 800; }
        
        .tag { background: #e2e8f0; padding: 4px 10px; border-radius: 15px; display: inline-flex; align-items: center; margin: 3px; font-size: 0.8rem; }
        .tag b { margin-left: 8px; color: var(--error); cursor: pointer; }
        
        .input-gramos { width: 65px; font-weight: bold; border: 1px solid var(--blue); border-radius: 4px; text-align: center; }
        .locked { background: #fee2e2 !important; border-color: var(--error); color: var(--error); }
        .deviation { font-size: 0.7rem; display: block; font-weight: bold; }
        .dev-ok { color: var(--accent); } .dev-err { color: var(--error); }

        .btn { padding: 10px 20px; border-radius: 6px; border: none; font-weight: bold; cursor: pointer; text-transform: uppercase; transition: 0.2s; }
        .btn-blue { background: var(--blue); color: white; width: 100%; }
        .btn-green { background: var(--accent); color: white; }
    </style>
</head>
<body>

<div class="container">
    <h1>üèîÔ∏è Dashboard Nutricional Cient√≠fico - Miquel V3.0</h1>

    <div id="status" class="card" style="padding:10px; font-size:0.8rem;">‚è≥ Cargando base de datos...</div>

    <div class="card">
        <h3>1. Configuraci√≥n de Biometr√≠a y Reparto de Macros</h3>
        <div class="grid-config">
            <div><label>Peso (kg)</label><input type="number" id="peso" value="75"></div>
            <div><label>Altura (cm)</label><input type="number" id="altura" value="180"></div>
            <div><label>Edad</label><input type="number" id="edad" value="35"></div>
            <div><label>G√©nero</label><select id="genero"><option value="hombre">Hombre</option><option value="mujer">Mujer</option></select></div>
            <div><label>Ajuste Kcal %</label><input type="number" id="ajusteKcal" value="0" step="1"></div>
        </div>

        <div style="overflow-x: auto; margin-top:20px;">
            <label>Multiplicadores por tipo de d√≠a (Prot y Grasa x kg peso)</label>
            <table>
                <tr><th>D√≠a</th><th>Gasto (Factor)</th><th>Prot (Mult)</th><th>Grasa (Mult)</th></tr>
                <tr><td>Alta</td><td><input type="number" id="mAlta" value="1.6" step="0.05"></td><td><input type="number" id="pAlta" value="2.0" step="0.1"></td><td><input type="number" id="gAlta" value="1.1" step="0.1"></td></tr>
                <tr><td>Media</td><td><input type="number" id="mMedia" value="1.45" step="0.05"></td><td><input type="number" id="pMedia" value="1.7" step="0.1"></td><td><input type="number" id="gMedia" value="1.1" step="0.1"></td></tr>
                <tr><td>Baja</td><td><input type="number" id="mBaja" value="1.2" step="0.05"></td><td><input type="number" id="pBaja" value="1.4" step="0.1"></td><td><input type="number" id="gBaja" value="0.7" step="0.1"></td></tr>
            </table>
        </div>

        <div style="overflow-x: auto; margin-top:20px;">
            <label>Reparto de Macros por Comida (% sobre el total diario)</label>
            <table class="reparto-table">
                <tr><th>Comida</th><th>Prot %</th><th>Grasa %</th><th>CH %</th></tr>
                <tr><td>Desayuno</td><td><input type="number" id="rep_des_p" value="10"></td><td><input type="number" id="rep_des_g" value="10"></td><td><input type="number" id="rep_des_ch" value="27"></td></tr>
                <tr><td>Comida</td><td><input type="number" id="rep_com_p" value="39"></td><td><input type="number" id="rep_com_g" value="40"></td><td><input type="number" id="rep_com_ch" value="26"></td></tr>
                <tr><td>Merienda</td><td><input type="number" id="rep_mer_p" value="8"></td><td><input type="number" id="rep_mer_g" value="6"></td><td><input type="number" id="rep_mer_ch" value="17"></td></tr>
                <tr><td>Cena</td><td><input type="number" id="rep_cen_p" value="43"></td><td><input type="number" id="rep_cen_g" value="44"></td><td><input type="number" id="rep_cen_ch" value="30"></td></tr>
            </table>
        </div>
        <button class="btn btn-blue" style="margin-top:20px;" onclick="calcularPresupuesto()">Calcular Presupuesto Diario</button>
    </div>

    <div id="seccionSeleccion" class="card" style="display:none;">
        <h3>2. Planificaci√≥n de la Jornada</h3>
        <label>Tipo de d√≠a a dise√±ar:</label>
        <select id="tipoDiaSel" style="width:200px; margin-bottom:15px;" onchange="recalcularTodo()">
            <option value="Alta">D√≠a Alta</option>
            <option value="Media">D√≠a Media</option>
            <option value="Baja">D√≠a Baja</option>
        </select>

        <label>Selecciona las comidas que vas a preparar hoy:</label>
        <div class="meal-selector">
            <label class="meal-checkbox"><input type="checkbox" value="desayuno" onchange="toggleMealSection(this)"> Desayuno</label>
            <label class="meal-checkbox"><input type="checkbox" value="comida" onchange="toggleMealSection(this)"> Comida</label>
            <label class="meal-checkbox"><input type="checkbox" value="merienda" onchange="toggleMealSection(this)"> Merienda</label>
            <label class="meal-checkbox"><input type="checkbox" value="cena" onchange="toggleMealSection(this)"> Cena</label>
        </div>
        <div id="resumenPresupuesto" style="font-size: 0.9rem; color: #475569;"></div>
    </div>

    <div id="mealContainer"></div>

    <div id="footerActions" class="card" style="display:none; text-align:right;">
        <button class="btn btn-green" onclick="exportarTodoCSV()">üì• Exportar Jornada Completa (CSV)</button>
    </div>
</div>

<script>
let dbAlimentos = [];
let mealsData = { desayuno: [], comida: [], merienda: [], cena: [] };
let presupuestoActual = null;

// CARGA CSV
window.onload = () => {
    fetch('alimentos.csv').then(r => r.text()).then(csv => {
        const lines = csv.split(/\r?\n/).filter(l => l.trim() !== "");
        dbAlimentos = lines.slice(1).map(l => {
            const c = l.split(/,(?=(?:(?:[^"]*"){2})*[^"]*$)/);
            return { n: c[0].replace(/"/g, '').trim(), kcal: pN(c[1]), p: pN(c[2]), g: pN(c[3]), ch: pN(c[4]) };
        }).filter(a => a.n !== "");
        document.getElementById('status').innerHTML = "‚úÖ Base de datos cargada. (" + dbAlimentos.length + " alimentos)";
    });
};

function pN(v) { return parseFloat(v?.replace(/"/g, '').replace(',', '.').trim()) || 0; }

function calcularPresupuesto() {
    const p = pN(document.getElementById('peso').value);
    const h = pN(document.getElementById('altura').value);
    const e = pN(document.getElementById('edad').value);
    const g = document.getElementById('genero').value;
    const adj = 1 + (pN(document.getElementById('ajusteKcal').value) / 100);

    const bmr = (g === 'hombre') ? (10 * p + 6.25 * h - 5 * e + 5) : (10 * p + 6.25 * h - 5 * e - 161);
    
    presupuestoActual = {};
    ['Alta', 'Media', 'Baja'].forEach(tipo => {
        const mK = pN(document.getElementById('m' + tipo).value);
        const mP = pN(document.getElementById('p' + tipo).value);
        const mG = pN(document.getElementById('g' + tipo).value);

        const kcalT = bmr * mK * adj;
        const protT = p * mP;
        const grasT = p * mG;
        const chT = (kcalT - (protT * 4) - (grasT * 9)) / 4;

        presupuestoActual[tipo] = { p: protT, g: grasT, ch: chT, kcal: kcalT, meals: {} };

        ['des', 'com', 'mer', 'cen'].forEach(m => {
            const key = m === 'des' ? 'desayuno' : m === 'com' ? 'comida' : m === 'mer' ? 'merienda' : 'cena';
            presupuestoActual[tipo].meals[key] = {
                p: protT * (pN(document.getElementById('rep_'+m+'_p').value)/100),
                g: grasT * (pN(document.getElementById('rep_'+m+'_g').value)/100),
                ch: chT * (pN(document.getElementById('rep_'+m+'_ch').value)/100)
            };
            const target = presupuestoActual[tipo].meals[key];
            target.kcal = (target.p * 4) + (target.g * 9) + (target.ch * 4);
        });
    });

    document.getElementById('seccionSeleccion').style.display = 'block';
    document.getElementById('footerActions').style.display = 'block';
    recalcularTodo();
}

function toggleMealSection(cb) {
    const meal = cb.value;
    if(cb.checked) {
        const html = `
            <div id="section_${meal}" class="card meal-section">
                <div class="meal-header">
                    <h3>üç≥ Planificando: ${meal.toUpperCase()}</h3>
                    <div id="target_${meal}" style="font-weight:bold; color:var(--blue); font-size:0.8rem;"></div>
                </div>
                <div class="grid-config">
                    <div style="grid-column: span 2;">
                        <input type="text" id="bus_${meal}" list="list_${meal}" placeholder="Buscar alimento (m√≠n. 3 letras)..." oninput="filtrar('${meal}', this.value)" onkeypress="if(event.key==='Enter') a√±adir('${meal}')">
                        <datalist id="list_${meal}"></datalist>
                    </div>
                    <button class="btn btn-blue" style="padding:5px;" onclick="a√±adir('${meal}')">A√±adir</button>
                </div>
                <div id="tags_${meal}" style="margin-bottom:15px;"></div>
                <div id="res_${meal}"></div>
            </div>`;
        document.getElementById('mealContainer').insertAdjacentHTML('beforeend', html);
        recalcularTodo();
    } else {
        document.getElementById('section_'+meal)?.remove();
        mealsData[meal] = [];
    }
}

function filtrar(meal, q) {
    const dl = document.getElementById('list_'+meal);
    if(q.length < 3) { dl.innerHTML = ""; return; }
    const matches = dbAlimentos.filter(a => a.n.toLowerCase().includes(q.toLowerCase())).slice(0,10);
    dl.innerHTML = matches.map(a => `<option value="${a.n}">`).join('');
}

function a√±adir(meal) {
    const input = document.getElementById('bus_'+meal);
    const item = dbAlimentos.find(a => a.n === input.value);
    if(item) {
        mealsData[meal].push({...item, gramos: 100, manual: false});
        input.value = "";
        renderMeal(meal);
    }
}

function updateGram(meal, idx, val) {
    mealsData[meal][idx].gramos = pN(val);
    mealsData[meal][idx].manual = true;
    renderMeal(meal);
}

function renderMeal(meal) {
    const dia = document.getElementById('tipoDiaSel').value;
    const target = presupuestoActual[dia].meals[meal];
    const data = mealsData[meal];

    if(data.length > 0) {
        // SOLVER
        for(let i=0; i<2000; i++) {
            let cP=0, cCH=0;
            data.forEach(s => { cP += s.p*s.gramos/100; cCH += s.ch*s.gramos/100; });
            let eP = target.p - cP, eCH = target.ch - cCH;
            data.forEach(s => {
                if(s.manual) return;
                let sP = s.p > 10 ? s.p/100 : 0.05, sCH = s.ch > 15 ? s.ch/100 : 0.05;
                s.gramos += (eP * sP + eCH * sCH) * 0.1;
                if(s.gramos < 0) s.gramos = 0;
            });
        }
    }

    // RENDER TABLE
    let tP=0, tG=0, tCH=0, tK=0;
    let rows = data.map((s, i) => {
        const sp=s.p*s.gramos/100, sg=s.g*s.gramos/100, sch=s.ch*s.gramos/100, sk=s.kcal*s.gramos/100;
        tP+=sp; tG+=sg; tCH+=sch; tK+=sk;
        return `<tr><td style="text-align:left">${s.n}</td>
            <td><input type="number" class="input-gramos ${s.manual?'locked':''}" value="${Math.round(s.gramos)}" onchange="updateGram('${meal}',${i},this.value)"></td>
            <td>${sp.toFixed(1)}</td><td>${sg.toFixed(1)}</td><td>${sch.toFixed(1)}</td>
            <td><b style="cursor:pointer;color:red" onclick="mealsData['${meal}'].splice(${i},1);renderMeal('${meal}')">‚úï</b></td></tr>`;
    }).join('');

    const dP=tP-target.p, dG=tG-target.g, dCH=tCH-target.ch, dK=tK-target.kcal;
    
    document.getElementById('target_'+meal).innerHTML = `OBJETIVO: ${target.kcal.toFixed(0)} Kcal | P: ${target.p.toFixed(1)} | G: ${target.g.toFixed(1)} | CH: ${target.ch.toFixed(1)}`;
    document.getElementById('res_'+meal).innerHTML = `
        <table>
            <tr><th>Alimento</th><th>Gramos</th><th>P</th><th>G</th><th>CH</th><th></th></tr>
            ${rows}
            <tr class="total-row"><td>TOTAL</td>
                <td>${tK.toFixed(0)} kcal <span class="deviation ${Math.abs(dK)<20?'dev-ok':'dev-err'}">(${dK>0?'+':''}${dK.toFixed(0)})</span></td>
                <td>${tP.toFixed(1)} <span class="deviation ${Math.abs(dP)<2?'dev-ok':'dev-err'}">(${dP>0?'+':''}${dP.toFixed(1)})</span></td>
                <td>${tG.toFixed(1)} <span class="deviation ${Math.abs(dG)<2?'dev-ok':'dev-err'}">(${dG>0?'+':''}${dG.toFixed(1)})</span></td>
                <td>${tCH.toFixed(1)} <span class="deviation ${Math.abs(dCH)<2?'dev-ok':'dev-err'}">(${dCH>0?'+':''}${dCH.toFixed(1)})</span></td>
                <td></td></tr>
        </table>`;
}

function recalcularTodo() {
    Object.keys(mealsData).forEach(m => {
        if(document.getElementById('section_'+m)) renderMeal(m);
    });
}

function exportarTodoCSV() {
    let csv = "\uFEFFD√≠a,Comida,Alimento,Gramos,Kcal,Proteina,Grasa,CH\n";
    const dia = document.getElementById('tipoDiaSel').value;
    
    Object.keys(mealsData).forEach(meal => {
        mealsData[meal].forEach(s => {
            const g = Math.round(s.gramos);
            csv += `${dia},${meal},"${s.n}",${g},${(s.kcal*g/100).toFixed(1)},${(s.p*g/100).toFixed(1)},${(s.g*g/100).toFixed(1)},${(s.ch*g/100).toFixed(1)}\n`;
        });
    });

    const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
    const link = document.createElement("a");
    link.href = URL.createObjectURL(blob);
    link.setAttribute("download", `Plan_Nutricional_Jornada_${dia}.csv`);
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
}
</script>
</body>
</html>
